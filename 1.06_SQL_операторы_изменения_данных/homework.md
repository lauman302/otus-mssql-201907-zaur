# Insert, Update, Merge

1. Довставлять в базу 5 записей используя insert в таблицу Customers или Suppliers
2. удалите 1 запись из Customers, которая была вами добавлена
3. изменить одну запись, из добавленных через UPDATE

    ```
    1.06.1-3.sql
    ```

4. Написать MERGE, который вставит вставит запись в клиенты, если ее там нет, и изменит
если она уже есть

    ----

    ```
    1.06.4.sql
    ```

    Остался вопрос: в MERGE нельзя использовать SEQUENCE, как задавать CustomerID? По результатам
    экспериментов, он просто присвоился сам, но где описано такое поведение я не нашёл. В скрипте
    генерации таблицы нет ни присвоения по умолчанию, ни IDENTITY. Видимо, я чего-то не понимаю.

5. Напишите запрос, который выгрузит данные через bcp out и загрузить через bulk insert

    ----

    ```
    1.06.5.sql
    ```

    Поскольку задания выполняются на базе MS SQL Server 2017 for Linux, запущенном
    в docker-контейнере, зафиксирую в документе ряд важных отличий.

    1. Справочная информация: [http://bit.ly/30A79uU][docker_bcp].
    2. Пути:
        * `bcp`: `/opt/mssql-tools/bin/bcp`. Вызов требует указания полного пути,
        т.к. он отсутствует в `$PATH`;
        * место хранения вылитого файла: `/var/opt/shared`. Этот путь был сконфигурирован
        при запуске docker-контейнера как расшаренная папка (подробнее см. ДЗ-1.01).
    3. `xp_cmdshell` не поддерживается в версии MS SQL Server for Linux: [http://bit.ly/2HoIn9N][xp_cmdshell_not_supported].
    Скрипт написан, но запуск утилиты при тестировании производился из коммандной строки.
    4. Для запуска из коммандной строки нужно подключиться к shell docker-контейнера:
        ```sh
        docker exec -it sql_otus /bin/bash
        ```
    5. При запуске из оболочки не работает trusted connection. Вместо него были указаны логин и пароль пользователя `sa`.
    6. При запуске из оболочки не сработало имя сервера, возвращённое из переменной `@@SERVERNAME`. Было заменено на `localhost`.
    7. Для корректной работы `BULK INSERT` потребовалось заменить разделитель строк (был выбран `###`), т.к. варианты
    `\n`, `\r`, `\r\n`, `0x0a` не срабатывали. Соответственно была исправлена команда выгрузки.

Рекомендуем сдать до: 25.08.2019

[docker_bcp]: http://bit.ly/30A79uU
[xp_cmdshell_not_supported]: http://bit.ly/2HoIn9N
